<img src="https://raw.github.com/NServiceBusExtensions/Newtonsoft.Json.Encryption/master/src/icon.png" height="25px"> Leverages the Newtonsoft extension API to encrypt/decrypt specific nodes at serialization time. So only the notes that require encryption are touched, the remaining content is still human readable. This approach provides an compromise between readability/debugabaility and security.

<!--- StartOpenCollectiveBackers -->

[Already a Patron? skip past this section](#endofbacking)


## Community backed

**It is expected that all developers [become a Patron](https://opencollective.com/nservicebusextensions/order/6976) to use any of these libraries. [Go to licensing FAQ](https://github.com/NServiceBusExtensions/Home/blob/master/readme.md#licensingpatron-faq)**


### Platinum Sponsors

Support this project by [becoming a Platinum Sponsor](https://opencollective.com/nservicebusextensions/order/7012). A banner with your company logo will be added here with a link to your website. The banner will also be added to all GitHub repositories under the NServiceBusExtensions organization. A "Sponsored by" text and link will be added the description of the NuGet Package for the life of your sponsorship. You also get 1 hour of remote support per month.

<!--
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/0/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/0/avatar.svg" height="100px"></a>
-->


### Gold Sponsors

Support this project by [becoming a Gold Sponsor](https://opencollective.com/nservicebusextensions/order/7001). A large company logo will be added here with a link to your website. The logo will also be added to all GitHub repositories under this organization.

<!--
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/0/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/0/avatar.svg" style="height:70px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/1/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/1/avatar.svg" style="height:70px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/2/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/2/avatar.svg" style="height:70px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/3/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/3/avatar.svg" style="height:70px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/4/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/4/avatar.svg" style="height:70px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/5/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/5/avatar.svg" style="height:70px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/6/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/6/avatar.svg" style="height:70px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/7/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/7/avatar.svg" style="height:70px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/8/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/8/avatar.svg" style="height:70px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/gold/9/website"><img src="https://opencollective.com/nservicebusextensions/tiers/gold/9/avatar.svg" style="height:70px;"></a>
-->


### Silver Sponsors

Support this project by [becoming a Silver Sponsors](https://opencollective.com/nservicebusextensions/order/6973). A medium company logo will be added here with a link to your website. The logo will also be added to all GitHub repositories under this organization.

<!--
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/0/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/0/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/1/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/1/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/2/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/2/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/3/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/3/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/4/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/4/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/5/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/5/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/6/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/6/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/7/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/7/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/8/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/8/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/9/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/9/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/10/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/10/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/11/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/11/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/12/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/12/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/13/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/13/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/14/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/14/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/15/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/15/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/16/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/16/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/17/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/17/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/18/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/18/avatar.svg" style="height:60px;"></a>
<a href="https://opencollective.com/nservicebusextensions/tiers/silver/19/website"><img src="https://opencollective.com/nservicebusextensions/tiers/silver/19/avatar.svg" style="height:60px;"></a>
-->


### Bronze Sponsors

Support this project by [becoming a Bronze Sponsors](https://opencollective.com/nservicebusextensions/order/6972). The company avatar will show up here with a link to your website. The avatar will also be added to all GitHub repositories under this organization.

<!--
<img src="https://opencollective.com/nservicebusextensions/tiers/bronze.svg?width=890&avatarHeight=80&button=false">
-->


### Patrons

Thanks to all the backing developers! Support this project by [becoming a patron](https://opencollective.com/nservicebusextensions/order/6976).

<img src="https://opencollective.com/nservicebusextensions/tiers/patron.svg?width=890&avatarHeight=60&button=false">

<!--

### Generous financial sponsors

<a href="https://opencollective.com/nservicebusextensions/sponsor/0/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/0/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/sponsor/1/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/1/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/sponsor/2/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/2/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/sponsor/3/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/3/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/sponsor/4/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/4/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/sponsor/5/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/5/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/sponsor/6/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/6/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/sponsor/7/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/7/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/sponsor/8/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/8/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/sponsor/9/website"><img src="https://opencollective.com/nservicebusextensions/sponsor/9/avatar.svg"></a>


### Generous financial backers

<a href="https://opencollective.com/nservicebusextensions/backer/0/website"><img src="https://opencollective.com/nservicebusextensions/backer/0/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/backer/1/website"><img src="https://opencollective.com/nservicebusextensions/backer/1/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/backer/2/website"><img src="https://opencollective.com/nservicebusextensions/backer/2/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/backer/3/website"><img src="https://opencollective.com/nservicebusextensions/backer/3/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/backer/4/website"><img src="https://opencollective.com/nservicebusextensions/backer/4/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/backer/5/website"><img src="https://opencollective.com/nservicebusextensions/backer/5/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/backer/6/website"><img src="https://opencollective.com/nservicebusextensions/backer/6/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/backer/7/website"><img src="https://opencollective.com/nservicebusextensions/backer/7/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/backer/8/website"><img src="https://opencollective.com/nservicebusextensions/backer/8/avatar.svg"></a>
<a href="https://opencollective.com/nservicebusextensions/backer/9/website"><img src="https://opencollective.com/nservicebusextensions/backer/9/avatar.svg"></a>

-->

<!--- EndOpenCollectiveBackers -->


<a href="#" id="endofbacking"></a>

## The NuGet package [![NuGet Status](http://img.shields.io/nuget/v/Newtonsoft.Json.Encryption.svg?style=flat)](https://www.nuget.org/packages/Newtonsoft.Json.Encryption/)

https://nuget.org/packages/Newtonsoft.Json.Encryption/

    PM> Install-Package Newtonsoft.Json.Encryption


## Encryption Algorithms

Any implementation of [SymmetricAlgorithm](https://msdn.microsoft.com/en-us/library/system.security.cryptography.symmetricalgorithm.aspx) is supported.


## Decorating properties

```C#
public class ClassToSerialize
{
    [Encrypt]
    public string Property { get; set; }
}
```


## Serialized

```C#
{
    "Property":"wSayABpFI3g7a/D6gGTq5g=="
}
```


## Supported property types

 * `string`
 * `byte[]`
 * `Guid`
 * `IDictionary<T, string>`
 * `IDictionary<T, byte[]>`
 * `IDictionary<T, Guid>`
 * `IEnumerable<string>`
 * `IEnumerable<byte[]>`
 * `IEnumerable<Guid>`

Note that only the values in a `IDictionary` are encrypted.


## Usage

The full serialize and deserialization workflow:

```C#
// per system (periodically rotated)
var key = Encoding.UTF8.GetBytes("gdDbqRpqdRbTs3mhdZh9qCaDaxJXl+e6");

// per app domain
using (var factory = new EncryptionFactory())
{
    var serializer = new JsonSerializer
    {
        ContractResolver = factory.GetContractResolver()
    };

    // transferred as meta data with the serialized payload
    byte[] initVector;

    string serialized;

    // per serialize session
    using (var algorithm = new RijndaelManaged
    {
        Key = key
    })
    {
        initVector = algorithm.IV;
        using (factory.GetEncryptSession(algorithm))
        {
            var instance = new ClassToSerialize
            {
                Property = "PropertyValue",
            };
            var builder = new StringBuilder();
            using (var writer = new StringWriter(builder))
            {
                serializer.Serialize(writer, instance);
            }
            serialized = builder.ToString();
        }
    }

    // per deserialize session
    using (var algorithm = new RijndaelManaged
    {
        IV = initVector,
        Key = key
    })
    {
        using (factory.GetDecryptSession(algorithm))
        using (var stringReader = new StringReader(serialized))
        using (var jsonReader = new JsonTextReader(stringReader))
        {
            var deserialized = serializer.Deserialize<ClassToSerialize>(jsonReader);
            Console.WriteLine(deserialized.Property);
        }
    }
}
```


## Breakdown


### Key

See [SymmetricAlgorithm.Key](https://msdn.microsoft.com/en-us/library/system.security.cryptography.symmetricalgorithm.key.aspx).

Example Key used for [RijndaelManaged algorithm](https://msdn.microsoft.com/en-us/library/system.security.cryptography.rijndaelmanaged.aspx) in the below sample code:

```C#
var key = Encoding.UTF8.GetBytes("gdDbqRpqdRbTs3mhdZh9qCaDaxJXl+e6");
```

A new valid key can be generated by instanitiating a [SymmetricAlgorithm](https://msdn.microsoft.com/en-us/library/system.security.cryptography.symmetricalgorithm.aspx) and accessing [SymmetricAlgorithm.Key](https://msdn.microsoft.com/en-us/library/system.security.cryptography.symmetricalgorithm.key.aspx).


### EncryptionFactory and JsonSerializer

Generally a single instance of `EncryptionFactory` will exist per AppDomain.

A single instance of `EncryptionFactory` is safe to be used for multiple instances of `JsonSerializer`. 

```C#
var factory = new EncryptionFactory();

var serializer = new JsonSerializer
{
    ContractResolver = factory.GetContractResolver()
};
```


### Serialization

A single encrypt session is used per serialization instance.

On instantiation the `SymmetricAlgorithm` will generate a valid [IV](https://msdn.microsoft.com/en-us/library/system.security.cryptography.symmetricalgorithm.iv.aspx). This is generally a good value to use for serialization and then stored for deserialization.

```C#
string serialized;

// per serialize session
using (var algorithm = new RijndaelManaged
{
    Key = key
})
{
    //TODO: store initVector for use in deserialization
    var initVector = algorithm.IV;
    using (factory.GetEncryptSession(algorithm))
    {
        var instance = new ClassToSerialize
        {
            Property = "PropertyValue",
        };
        var builder = new StringBuilder();
        using (var writer = new StringWriter(builder))
        {
            serializer.Serialize(writer, instance);
        }
        serialized = builder.ToString();
    }
}
```


### Deserialization

A single decrypt session is used per serialization instance.

 * `key` must be the same as the one use for serialization.
 * `initVector` must be the same as the one use for serialization. It is safe to be transferred with the serialized text. 

```C#
using (var algorithm = new RijndaelManaged
{
    IV = initVector,
    Key = key
})
{
    using (factory.GetDecryptSession(algorithm))
    using (var stringReader = new StringReader(serialized))
    using (var jsonReader = new JsonTextReader(stringReader))
    {
        var deserialized = serializer.Deserialize<ClassToSerialize>(jsonReader);
        Console.WriteLine(deserialized.Property);
    }
}
```


## Rebus


### The NuGet package [![NuGet Status](http://img.shields.io/nuget/v/Rebus.Newtonsoft.Encryption.svg?style=flat)](https://www.nuget.org/packages/Rebus.Newtonsoft.Encryption/)

https://nuget.org/packages/Rebus.Newtonsoft.Encryption/

    PM> Install-Package Rebus.Newtonsoft.Encryption


### Usage

```C#
var activator = new BuiltinHandlerActivator();

activator.Register(() => new Handler());
var configurer = Configure.With(activator);

var encryptionFactory = new EncryptionFactory();
var settings = new JsonSerializerSettings
{
    TypeNameHandling = TypeNameHandling.All,
    ContractResolver = encryptionFactory.GetContractResolver()
};
configurer.Serialization(s => { s.UseNewtonsoftJson(settings); });
configurer.EnableJsonEncryption(
    encryptionFactory: encryptionFactory,
    encryptStateBuilder: () =>
        (
        algorithm: new RijndaelManaged
        {
            Key = key
        },
        keyId: "1"
        ),
    decryptStateBuilder: (keyId, initVector) =>
        new RijndaelManaged
        {
            Key = key,
            IV = initVector
        });
```


## NServiceBus


### The NuGet package [![NuGet Status](http://img.shields.io/nuget/v/NServiceBus.Newtonsoft.Encryption.svg?style=flat)](https://www.nuget.org/packages/NServiceBus.Newtonsoft.Encryption/)

https://nuget.org/packages/NServiceBus.Newtonsoft.Encryption/

    PM> Install-Package NServiceBus.Newtonsoft.Encryption


### Usage

```C#
var configuration = new EndpointConfiguration("NServiceBusSample");
var serialization = configuration.UseSerialization<NewtonsoftSerializer>();
var encryptionFactory = new EncryptionFactory();
serialization.Settings(
    new JsonSerializerSettings
    {
        ContractResolver = encryptionFactory.GetContractResolver()
    });

configuration.EnableJsonEncryption(
    encryptionFactory: encryptionFactory,
    encryptStateBuilder: () =>
        (
        algorithm: new RijndaelManaged
        {
            Key = key
        },
        keyId: "1"
        ),
    decryptStateBuilder: (keyId, initVector) =>
        new RijndaelManaged
        {
            Key = key,
            IV = initVector
        });
```


## Icon


<a href="https://thenounproject.com/term/lock/59296/" target="_blank">Lock</a> designed by <a href="https://thenounproject.com/molumen/" target="_blank">Mourad Mokrane</a> from The Noun Project

Lock by from the Noun Project

